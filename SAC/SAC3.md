# Solution Architecture Contract - LangGraph Agent (Working State + Plan, short)

## Цель
Стабилизировать поведение агента для многошаговых задач (сбор, сравнение, обобщение), используя LangGraph:
- явный граф шагов вместо ручного decision loop
- минимальный working state, который сохраняется между сообщениями в chat-режиме
- без хранения истории страниц, DOM и `eid` между шагами

Контракт описывает только логику агента. Transport, MCP, policy, chat mode, SSE/WS считаются заданными.

---

## Модель выполнения (обязательная)

Агент должен работать как LangGraph-цикл:

1) **Сформировать/обновить цель** (current_goal) из сообщения пользователя
2) **Составить план** (3-6 пунктов)
3) **Выполнять план пошагово**, повторяя цикл:
   - при необходимости получить актуальное состояние страницы (observe)
   - выбрать следующий шаг (или replanning)
   - выполнить одно действие (tool call)
   - обновить working state (progress, facts)
4) **Последний пункт плана всегда** - ответ пользователю (finalize)

Цикл продолжается до:
- выдачи финального ответа,
- достижения лимита шагов,
- запроса ручного вмешательства пользователя (interrupt).

---

## Working State (минимальный, живет в LangGraph state)

Working state обязателен и сохраняется между шагами в chat-режиме в LangGraph state (thread_id = session_id). Session не является источником истины.

Обязательные поля:
- **current_goal**  
  Текущая цель пользователя. Используется как якорь для "продолжай", "да", "готово".

- **plan**  
  Короткий план из 3-6 пунктов. Последний пункт - ответ пользователю.

- **progress**  
  Ход выполнения:
  - текущий пункт плана (index или label)
  - что уже сделано
  - что заблокировано или требует replanning

Опциональные поля:
- **facts**  
  Обобщенная полезная информация, извлеченная по ходу работы. Требования:
  - хранить факты списком словарей с ключом `fact`
  - не хранить страницы, DOM или `eid`
  - не копировать сырой текст
  - хранить обобщения, а не дословные куски
  - обновлять через аккуратное обобщение (append/merge), без переписывания "с нуля"

Технические поля состояния (внутренние, допустимы):
- `messages` (история диалога)
- `last_observation`, `last_screenshot`
- `planned_action` (только текущий шаг)
- счетчики (`tool_steps`, `invalid_actions`) и флаги (`needs_observe`)

---

## Observation и Screenshot

- **Observe node всегда делает screenshot + observe вместе**
  - observe => screenshot + observe
  - если observe не вызывается, screenshot тоже не делается

- **Observation должен быть максимально полным**, чтобы агент не терял `eid` для действий.
  Лучше избыточный контекст, чем отсутствие элемента.

- История страниц не сохраняется и не используется.

- Агент опирается только на:
  - текущий observation + screenshot (если был observe)
  - working state
  - цель пользователя

---

## Планирование и replanning

- План строится при начале задачи или если текущий план стал нерелевантным.
- План может быть изменен в любой момент, если:
  - элемент не найден
  - данные не соответствуют ожиданиям
  - пользователь дал обратную связь
  - страница изменилась и прежние допущения сломались
- Уже собранные обобщенные факты (facts) должны сохраняться при replanning.

---

## Human in the loop (interrupt)

- Подтверждения и ручные шаги реализуются через LangGraph interrupt/resume.
- При необходимости вмешательства агент делает interrupt с причиной и ожидаемым действием пользователя.
- После resume агент продолжает с текущей целью и working state, при необходимости выполняет observe.

---

## Завершение и лимиты

- Агент выполняет шаги до лимита (`MAX_TOOL_STEPS`, считается по всем нодам графа).
- При достижении лимита агент:
  - подводит итог (что сделано, что нет)
  - предлагает продолжить
- Продолжение происходит обычным сообщением в чате (тот же thread_id).

---

## Ключевые ограничения
- Агент не должен хранить:
  - историю DOM
  - историю страниц
  - `eid` между шагами в working state
- Агент должен оставаться универсальным и не привязанным к сайтам.
- Любое `eid` допустимо только как часть текущего `planned_action` и не переносится в facts/plan.

---

## Критерий успеха
Агент способен:
- выполнять задачи, требующие сбора и сравнения информации,
- не терять уже полученные результаты (через facts/progress),
- корректно завершать задачу без обязательных возвратов по страницам,
- корректно работать через interrupt/resume.
